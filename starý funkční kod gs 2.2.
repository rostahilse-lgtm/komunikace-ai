// KONFIGURACE
const SPREADSHEET_ID = '1OMSWRrn2aBHMItjx4Vu0Syn4PII8F1uw-GSWEuaoZGo';
const SHEET_NAMES = {
  WORKERS: 'pracovníci',
  CONTRACTS: 'zakázky',
  JOBS: 'práce',
  PLACES: 'místo',
  RECORDS: 'záznamy',
  ADVANCES: 'zálohy',
  RATES: 'hodinové sazby',
  LUNCH_PRICES: 'ceny obědů'
};

function doGet(e) {
  const action = e.parameter.action;
  
  try {
    let result;
    
    switch(action) {
      case 'get': 
        result = getData(e); 
        break;
      case 'saverecord': 
        result = addRecord(e); 
        break;
      case 'savelunch': 
        result = setPaymentRequestLunch(e); 
        break;
      case 'saveadvance': 
        result = setPaymentRequest(e); 
        break;
      case 'getsummary': 
        result = getWorkerFinances(e); 
        break;
      case 'getrecords': 
        result = getWorkerRecords(e); 
        break;
      case 'getadvances': 
        result = getWorkerAdvances(e); 
        break;
      case 'getallrecords': 
        result = getAllRecords(e); 
        break;
      case 'getalladvances': 
        result = getAllAdvances(e); 
        break;
      case 'getallsummary': 
        result = getAllSummary(e); 
        break;
      case 'getdayrecords': 
        result = getDayRecords(e); 
        break;
      case 'updaterecord': 
        result = updateRecord(e); 
        break;
      case 'deleterecord': 
        result = deleteRecord(e); 
        break;
      case 'getcontractkm': 
        result = getContractKm(e); 
        break;
      case 'checktodaytrip': 
        result = checkTodayTrip(e); 
        break;
      default: 
        result = { code: '000', error: '', data: { status: 'ok', message: 'API funguje', version: '2.1' } };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ 
        code: '999', 
        error: error.toString(), 
        data: null 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getData(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const type = e.parameter.type;
    let sheet, data;
   
    switch(type) {
      case 'workers':
        sheet = ss.getSheetByName(SHEET_NAMES.WORKERS);
        const wLastRow = sheet.getLastRow();
        if (wLastRow > 1) {
          data = sheet.getRange(2, 1, wLastRow - 1, 4).getValues();
        } else {
          data = [];
        }
        break;
       
      case 'contracts':
        sheet = ss.getSheetByName(SHEET_NAMES.CONTRACTS);
        const cLastRow = sheet.getLastRow();
        if (cLastRow > 1) {
          data = sheet.getRange(2, 1, cLastRow - 1, 4).getValues()
            .filter(row => row[2] === 'Y');
        } else {
          data = [];
        }
        break;
       
      case 'jobs':
        sheet = ss.getSheetByName(SHEET_NAMES.JOBS);
        const jLastRow = sheet.getLastRow();
        if (jLastRow > 1) {
          data = sheet.getRange(2, 1, jLastRow - 1, 3).getValues()
            .filter(row => row[2] === 'Y');
        } else {
          data = [];
        }
        break;
       
      case 'places':
        sheet = ss.getSheetByName(SHEET_NAMES.PLACES);
        const pLastRow = sheet.getLastRow();
        if (pLastRow > 1) {
          data = sheet.getRange(2, 1, pLastRow - 1, 4).getValues()
            .filter(row => row[2] === 'Y');
        } else {
          data = [];
        }
        break;
       
      case 'records':
        sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
        const rLastRow = sheet.getLastRow();
        if (rLastRow > 1) {
          data = sheet.getRange(2, 1, rLastRow - 1, 15).getValues();
        } else {
          data = [];
        }
        break;
       
      default:
        return { code: '101', error: 'Neplatný typ: ' + type, data: null };
    }
   
    return { code: '000', error: '', data: data };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getWorkerRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const idWorker = e.parameter.id_worker;
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const filtered = [];
   
    for (let i = 1; i < records.length; i++) {
      if (String(records[i][1]) === String(idWorker)) {
        filtered.push(records[i]);
      }
    }
   
    return { code: '000', error: '', data: filtered.reverse().slice(0, 30) };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getWorkerAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const idWorker = e.parameter.id_worker;
    const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
    const filtered = [];
   
    for (let i = 1; i < advances.length; i++) {
      if (String(advances[i][0]) === String(idWorker)) {
        filtered.push(advances[i]);
      }
    }
   
    return { code: '000', error: '', data: filtered.reverse().slice(0, 30) };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const data = [];
    
    for (let i = 1; i < records.length; i++) {
      data.push(records[i]);
    }
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
    const data = [];
    
    for (let i = 1; i < advances.length; i++) {
      data.push(advances[i]);
    }
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getDayRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const dateStr = e.parameter.date;
    const parts = dateStr.split('. ');
    const targetDate = new Date(parts[2], parts[1] - 1, parts[0]);
    const nextDay = new Date(targetDate);
    nextDay.setDate(nextDay.getDate() + 1);
   
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const filtered = [];
   
    for (let i = 1; i < records.length; i++) {
      const recordDate = new Date(records[i][4]);
      if (recordDate >= targetDate && recordDate < nextDay) {
        const record = [
          records[i][0],  // nameContract
          records[i][1],  // idWorker
          records[i][2],  // rate
          records[i][3],  // nameJob
          records[i][4],  // timeFr
          records[i][5],  // timeTo
          records[i][6],  // nameWorker
          records[i][7],  // hours
          records[i][8],  // note
          records[i][9],  // dateTimeFr
          records[i][10], // dateTimeTo
          records[i][11], // kmJednosmer
          records[i][12], // kmCelkem
          records[i][13], // kmRucne
          records[i][14]  // idPlace
        ];
        filtered.push(record);
      }
    }
   
    return { code: '000', error: '', data: filtered };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getWorkerFinances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const idWorker = e.parameter.id_worker;
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
   
    let totalEarnings = 0;
    let totalPaid = 0;
   
    for (let i = 1; i < records.length; i++) {
      if (String(records[i][1]) === String(idWorker)) {
        const rate = parseFloat(records[i][2]) || 0;
        const hours = parseFloat(records[i][7]) || 0;
        totalEarnings += (rate * hours);
      }
    }
   
    for (let i = 1; i < advances.length; i++) {
      if (String(advances[i][0]) === String(idWorker)) {
        totalPaid += parseFloat(advances[i][4]) || 0;
      }
    }
   
    return { 
      code: '000', 
      error: '', 
      data: {
        totalEarnings: Math.round(totalEarnings),
        totalPaid: Math.round(totalPaid),
        balance: Math.round(totalEarnings - totalPaid)
      }
    };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllSummary(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const workersData = ss.getSheetByName(SHEET_NAMES.WORKERS).getDataRange().getValues();
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
    const summary = [];
   
    for (let w = 1; w < workersData.length; w++) {
      const workerId = workersData[w][0];
      const workerName = workersData[w][1];
      let totalEarnings = 0;
      let totalPaid = 0;
     
      for (let i = 1; i < records.length; i++) {
        if (String(records[i][1]) === String(workerId)) {
          const rate = parseFloat(records[i][2]) || 0;
          const hours = parseFloat(records[i][7]) || 0;
          totalEarnings += (rate * hours);
        }
      }
     
      for (let i = 1; i < advances.length; i++) {
        if (String(advances[i][0]) === String(workerId)) {
          totalPaid += parseFloat(advances[i][4]) || 0;
        }
      }
     
      summary.push({
        id: workerId,
        name: workerName,
        totalEarnings: Math.round(totalEarnings),
        totalPaid: Math.round(totalPaid),
        balance: Math.round(totalEarnings - totalPaid)
      });
    }
   
    return { code: '000', error: '', data: summary };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function addRecord(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheetRecords = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const idContract = e.parameter.id_contract;
    const idWorker = e.parameter.id_worker;
    const idJob = e.parameter.id_job;
    const idPlace = e.parameter.id_place || null;
    const timeFr = parseInt(e.parameter.time_fr);
    const timeTo = parseInt(e.parameter.time_to);
    const note = e.parameter.note || '';
    const recordDate = new Date(timeFr);
    const kmJednosmer = parseFloat(e.parameter.km_jednosmer) || 0;
    const kmCelkem = parseFloat(e.parameter.km_celkem) || 0;
    const kmRucne = e.parameter.km_rucne || 'N';
   
    const nameContract = getNameById(ss, SHEET_NAMES.CONTRACTS, idContract);
    const nameJob = getNameById(ss, SHEET_NAMES.JOBS, idJob);
    const nameWorker = getNameById(ss, SHEET_NAMES.WORKERS, idWorker);
    const namePlace = idPlace ? getNameById(ss, SHEET_NAMES.PLACES, idPlace) : '';
    const rate = getWorkerRate(ss, idWorker, recordDate);
    
    const hours = (timeTo - timeFr) / 3600000;
    const dateTimeFr = Utilities.formatDate(new Date(timeFr), 'GMT+1', 'dd. MM. yyyy HH:mm');
    const dateTimeTo = Utilities.formatDate(new Date(timeTo), 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    sheetRecords.appendRow([
      nameContract,
      idWorker,
      rate,
      nameJob,
      timeFr,
      timeTo,
      nameWorker,
      hours,
      note,
      dateTimeFr,
      dateTimeTo,
      kmJednosmer,
      kmCelkem,
      kmRucne,
      namePlace
    ]);
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function updateRecord(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const rowIndex = parseInt(e.parameter.row_index);
    const idContract = e.parameter.id_contract;
    const idJob = e.parameter.id_job;
    const timeFr = parseInt(e.parameter.time_fr);
    const timeTo = parseInt(e.parameter.time_to);
    const note = e.parameter.note || '';
    const kmJednosmer = parseFloat(e.parameter.km_jednosmer) || 0;
    const kmCelkem = parseFloat(e.parameter.km_celkem) || 0;
    const kmRucne = e.parameter.km_rucne || 'N';
   
    const nameContract = getNameById(ss, SHEET_NAMES.CONTRACTS, idContract);
    const nameJob = getNameById(ss, SHEET_NAMES.JOBS, idJob);
    
    const hours = (timeTo - timeFr) / 3600000;
    const dateTimeFr = Utilities.formatDate(new Date(timeFr), 'GMT+1', 'dd. MM. yyyy HH:mm');
    const dateTimeTo = Utilities.formatDate(new Date(timeTo), 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    const row = rowIndex + 2;
    sheet.getRange(row, 1).setValue(nameContract);
    sheet.getRange(row, 4).setValue(nameJob);
    sheet.getRange(row, 5).setValue(timeFr);
    sheet.getRange(row, 6).setValue(timeTo);
    sheet.getRange(row, 8).setValue(hours);
    sheet.getRange(row, 9).setValue(note);
    sheet.getRange(row, 10).setValue(dateTimeFr);
    sheet.getRange(row, 11).setValue(dateTimeTo);
    sheet.getRange(row, 12).setValue(kmJednosmer);
    sheet.getRange(row, 13).setValue(kmCelkem);
    sheet.getRange(row, 14).setValue(kmRucne);
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function deleteRecord(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const rowIndex = parseInt(e.parameter.row_index);
    sheet.deleteRow(rowIndex + 2);
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function setPaymentRequestLunch(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const time = parseInt(e.parameter.time);
    const lunchDate = new Date(time);
    
    const price = getLunchPrice(ss, lunchDate);
    const dateTime = Utilities.formatDate(lunchDate, 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    ss.getSheetByName(SHEET_NAMES.ADVANCES).appendRow([
      e.parameter.id_worker,
      time,
      e.parameter.name_worker,
      dateTime,
      price,
      'oběd'
    ]);
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function setPaymentRequest(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const time = parseInt(e.parameter.time);
    const dateTime = Utilities.formatDate(new Date(time), 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    ss.getSheetByName(SHEET_NAMES.ADVANCES).appendRow([
      e.parameter.id_worker,
      time,
      e.parameter.name_worker,
      dateTime,
      parseFloat(e.parameter.payment),
      e.parameter.payment_reason
    ]);
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getNameById(ss, sheetName, id) {
  const data = ss.getSheetByName(sheetName).getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(id)) {
      return data[i][1];
    }
  }
  return id;
}

function getWorkerRate(ss, idWorker, recordDate) {
  const ratesData = ss.getSheetByName(SHEET_NAMES.RATES).getDataRange().getValues();
  for (let i = 1; i < ratesData.length; i++) {
    if (String(ratesData[i][0]) === String(idWorker)) {
      const dFrom = new Date(ratesData[i][3]);
      const dTo = new Date(ratesData[i][4]);
      if (recordDate >= dFrom && recordDate <= dTo) {
        return ratesData[i][2];
      }
    }
  }
  return 0;
}

function getLunchPrice(ss, lunchDate) {
  const pricesData = ss.getSheetByName(SHEET_NAMES.LUNCH_PRICES).getDataRange().getValues();
  for (let i = 1; i < pricesData.length; i++) {
    const dFrom = new Date(pricesData[i][1]);
    const dTo = new Date(pricesData[i][2]);
    if (lunchDate >= dFrom && lunchDate <= dTo) {
      return pricesData[i][0];
    }
  }
  return 0;
}

function getContractKm(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const contractsSheet = ss.getSheetByName(SHEET_NAMES.CONTRACTS);
    const data = contractsSheet.getDataRange().getValues();
    const contractId = e.parameter.id_contract;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(contractId)) {
        const km = data[i][3] || 0;
        return { code: '000', error: '', data: { km: km } };
      }
    }
    
    return { code: '000', error: '', data: { km: 0 } };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function checkTodayTrip(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const recordsSheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const data = recordsSheet.getDataRange().getValues();
    const contractName = e.parameter.id_contract;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayMs = today.getTime();
    
    for (let i = 1; i < data.length; i++) {
      const recordDate = new Date(data[i][4]);
      recordDate.setHours(0, 0, 0, 0);
      const recordDateMs = recordDate.getTime();
      const recordContractName = String(data[i][0]);
      const recordKm = data[i][12] || 0;
      
      if (recordDateMs === todayMs && recordContractName === contractName && recordKm > 0) {
        return { 
          code: '000', 
          error: '', 
          data: { 
            exists: true, 
            km: recordKm,
            worker: data[i][6]
          }
        };
      }
    }
    
    return { code: '000', error: '', data: { exists: false } };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}
