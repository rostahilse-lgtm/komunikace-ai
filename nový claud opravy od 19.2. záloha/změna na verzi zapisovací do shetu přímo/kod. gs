// KONFIGURACE
const SPREADSHEET_ID = '1OMSWRrn2aBHMItjx4Vu0Syn4PII8F1uw-GSWEuaoZGo';
const SHEET_NAMES = {
  WORKERS: 'pracovníci',
  CONTRACTS: 'zakázky',
  JOBS: 'práce',
  PLACES: 'místo',
  RECORDS: 'záznamy',
  ADVANCES: 'zálohy',
  RATES: 'hodinové sazby',
  LUNCH_PRICES: 'ceny obědů'
};

function doGet(e) {
  const action = e.parameter.action;
  
  try {
    let result;
    
    switch(action) {
      case 'get': 
        result = getData(e); 
        break;
      case 'saverecord': 
        result = addRecord(e); 
        break;
      case 'savelunch': 
        result = setPaymentRequestLunch(e); 
        break;
      case 'saveadvance': 
        result = setPaymentRequest(e); 
        break;
      case 'getsummary': 
        result = getWorkerFinances(e); 
        break;
      case 'getrecords': 
        result = getWorkerRecords(e); 
        break;
      case 'getadvances': 
        result = getWorkerAdvances(e); 
        break;
      case 'getallrecords': 
        result = getAllRecords(e); 
        break;
      case 'getalladvances': 
        result = getAllAdvances(e); 
        break;
      case 'getallsummary': 
        result = getAllSummary(e); 
        break;
      case 'getdayrecords': 
        result = getDayRecords(e); 
        break;
      case 'updaterecord': 
        result = updateRecord(e); 
        break;
      case 'deleterecord': 
        result = deleteRecord(e); 
        break;
      case 'getcontractkm': 
        result = getContractKm(e); 
        break;
      case 'checktodaytrip': 
        result = checkTodayTrip(e); 
        break;
      case 'getworkerstartdata':
        result = getAllWorkersStartData(e);
        break;
      case 'gethistorysummary':
        result = getHistorySummary(e);
        break;
      case 'gethistoryrecords':
        result = getHistoryRecords(e);
        break;
      case 'gethistoryadvances':
        result = getHistoryAdvances(e);
        break;
      // HISTORIE - načítá se jen na vyžádání (lazy load)
      case 'gethistoryrecords':
        result = getHistoryRecords(e);
        break;
      case 'gethistoryadvances':
        result = getHistoryAdvances(e);
        break;
      case 'gethistorysummary':
        result = getHistorySummary(e);
        break;
      default: 
        result = { code: '000', error: '', data: { status: 'ok', message: 'API funguje', version: '2.2' } };
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ 
        code: '999', 
        error: error.toString(), 
        data: null 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getData(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const type = e.parameter.type;
    let sheet, data;
   
    switch(type) {
      case 'workers':
        sheet = ss.getSheetByName(SHEET_NAMES.WORKERS);
        const wLastRow = sheet.getLastRow();
        if (wLastRow > 1) {
          // Čteme 4 sloupce: A=id, B=jméno, C=aktivní, D=admin
          data = sheet.getRange(2, 1, wLastRow - 1, 4).getValues();
        } else {
          data = [];
        }
        break;
       
      case 'contracts':
        sheet = ss.getSheetByName(SHEET_NAMES.CONTRACTS);
        const cLastRow = sheet.getLastRow();
        if (cLastRow > 1) {
          data = sheet.getRange(2, 1, cLastRow - 1, 4).getValues()
            .filter(row => row[2] === 'Y');
        } else {
          data = [];
        }
        break;
       
      case 'jobs':
        sheet = ss.getSheetByName(SHEET_NAMES.JOBS);
        const jLastRow = sheet.getLastRow();
        if (jLastRow > 1) {
          data = sheet.getRange(2, 1, jLastRow - 1, 3).getValues()
            .filter(row => row[2] === 'Y');
        } else {
          data = [];
        }
        break;
       
      case 'places':
        sheet = ss.getSheetByName(SHEET_NAMES.PLACES);
        const pLastRow = sheet.getLastRow();
        if (pLastRow > 1) {
          data = sheet.getRange(2, 1, pLastRow - 1, 4).getValues()
            .filter(row => row[2] === 'Y');
        } else {
          data = [];
        }
        break;
       
      case 'records':
        sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
        const rLastRow = sheet.getLastRow();
        if (rLastRow > 1) {
          data = sheet.getRange(2, 1, rLastRow - 1, 15).getValues();
        } else {
          data = [];
        }
        break;
       
      default:
        return { code: '101', error: 'Neplatný typ: ' + type, data: null };
    }
   
    return { code: '000', error: '', data: data };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getWorkerRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const idWorker = e.parameter.id_worker;
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const filtered = [];
   
    for (let i = 1; i < records.length; i++) {
      if (String(records[i][1]) === String(idWorker)) {
        filtered.push(records[i]);
      }
    }
   
    return { code: '000', error: '', data: filtered.reverse().slice(0, 30) };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getWorkerAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const idWorker = e.parameter.id_worker;
    const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
    const filtered = [];
   
    for (let i = 1; i < advances.length; i++) {
      if (String(advances[i][0]) === String(idWorker)) {
        filtered.push(advances[i]);
      }
    }
   
    return { code: '000', error: '', data: filtered.reverse().slice(0, 30) };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const source = e.parameter.source || 'new';
    const dateFrom = e.parameter.date_from ? new Date(parseInt(e.parameter.date_from)) : null;
    const dateTo = e.parameter.date_to ? new Date(parseInt(e.parameter.date_to)) : null;
    if (dateTo) dateTo.setHours(23, 59, 59, 999);
    
    const records = loadRecordsBySource(ss, source, dateFrom, dateTo);
    const data = records.map(r => r.row);
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const source = e.parameter.source || 'new';
    const dateFrom = e.parameter.date_from ? new Date(parseInt(e.parameter.date_from)) : null;
    const dateTo = e.parameter.date_to ? new Date(parseInt(e.parameter.date_to)) : null;
    if (dateTo) dateTo.setHours(23, 59, 59, 999);
    
    const advances = loadAdvancesBySource(ss, source, dateFrom, dateTo);
    const data = advances.map(a => a.row);
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

// ============================================================
// getDayRecords - vrátí záznamy dne + index řádku + příznak opraveno
// Příznak opraveno čte ze sloupce P (sloupec 16) - žádné čtení barev
// ============================================================
function getDayRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const dateStr = e.parameter.date;
    const parts = dateStr.split('. ');
    const targetDate = new Date(parts[2], parts[1] - 1, parts[0]);
    const nextDay = new Date(targetDate);
    nextDay.setDate(nextDay.getDate() + 1);
   
    const sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { code: '000', error: '', data: [] };
    
    // Načíst data včetně sloupce P (16 sloupců = A až P)
    const records = sheet.getRange(1, 1, lastRow, 16).getValues();
    const filtered = [];
   
    for (let i = 1; i < records.length; i++) {
      const recordDate = new Date(records[i][4]);
      if (recordDate >= targetDate && recordDate < nextDay) {
        
        // Sloupec P (index 15) = 'opraveno' nebo 'nový' - příznak stavu záznamu
        const stavP = String(records[i][15] || '').trim();
        const jeOpraveno = (stavP === 'opraveno' || stavP === 'nový') ? stavP : '';
        
        const record = [
          records[i][0],   // [0]  nameContract
          records[i][1],   // [1]  idWorker
          records[i][2],   // [2]  rate
          records[i][3],   // [3]  nameJob
          records[i][4],   // [4]  timeFr
          records[i][5],   // [5]  timeTo
          records[i][6],   // [6]  nameWorker
          records[i][7],   // [7]  hours
          records[i][8],   // [8]  note
          records[i][9],   // [9]  dateTimeFr
          records[i][10],  // [10] dateTimeTo
          records[i][11],  // [11] kmJednosmer
          records[i][12],  // [12] kmCelkem
          records[i][13],  // [13] kmRucne
          records[i][14],  // [14] idPlace
          jeOpraveno,      // [15] 'opraveno' / 'nový' / '' - pro ikonky ✏️ ➕ v apce
          i                // [16] skutečný index řádku v sheetu (updateRecord: row = i + 1)
        ];
        filtered.push(record);
      }
    }
   
    return { code: '000', error: '', data: filtered };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

// ============================================================
// POMOCNÁ FUNKCE - načte datum přechodu a počáteční stav pracovníka
// Sloupec E = datum přechodu, F = počáteční částka
// Pokud není datum, vrátí null (= počítat vše)
// ============================================================
function getWorkerStartData(workersData, idWorker) {
  for (let i = 1; i < workersData.length; i++) {
    if (String(workersData[i][0]) === String(idWorker)) {
      const datumRaw = workersData[i][4]; // sloupec E
      const pocatek = parseFloat(workersData[i][5]) || 0; // sloupec F
      if (datumRaw) {
        // Google Sheets vrací datum jako Date objekt přímo - stačí ho použít
        // Pokud je to číslo (serial date), převedeme ho
        let datumOd;
        if (datumRaw instanceof Date) {
          datumOd = datumRaw;
        } else if (typeof datumRaw === 'number') {
          // Google Sheets serial date: dny od 30.12.1899
          datumOd = new Date((datumRaw - 25569) * 86400000);
        } else {
          datumOd = new Date(datumRaw);
        }
        // Nastavit čas na začátek dne aby porovnání fungovalo správně
        datumOd.setHours(0, 0, 0, 0);
        return { datumOd: datumOd, pocatek: pocatek };
      }
      return { datumOd: null, pocatek: 0 };
    }
  }
  return { datumOd: null, pocatek: 0 };
}

function getWorkerFinances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const idWorker = e.parameter.id_worker;
    const workersData = ss.getSheetByName(SHEET_NAMES.WORKERS).getDataRange().getValues();
    const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
    const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
    
    // Načíst datum přechodu a počáteční stav
    const startData = getWorkerStartData(workersData, idWorker);
    const datumOd = startData.datumOd;
    
    let totalEarnings = 0;
    let totalPaid = 0;
   
    for (let i = 1; i < records.length; i++) {
      if (String(records[i][1]) === String(idWorker)) {
        // Filtr od data přechodu (pokud je nastaveno)
        if (datumOd) {
          const recordDate = new Date(records[i][4]);
          if (recordDate < datumOd) continue;
        }
        const rate = parseFloat(records[i][2]) || 0;
        const hours = parseFloat(records[i][7]) || 0;
        totalEarnings += (rate * hours);
      }
    }
   
    for (let i = 1; i < advances.length; i++) {
      if (String(advances[i][0]) === String(idWorker)) {
        // Filtr od data přechodu (pokud je nastaveno)
        if (datumOd) {
          const advanceDate = new Date(advances[i][1]);
          if (advanceDate < datumOd) continue;
        }
        totalPaid += parseFloat(advances[i][4]) || 0;
      }
    }
    
    // Přidat počáteční stav k výdělku
    const balance = Math.round(startData.pocatek + totalEarnings - totalPaid);
   
    return { 
      code: '000', 
      error: '', 
      data: {
        totalEarnings: Math.round(totalEarnings),
        totalPaid: Math.round(totalPaid),
        pocatek: startData.pocatek,
        balance: balance
      }
    };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}


// STARÝ FUNGUJÍCÍ getAllSummary BEZ FILTRŮ
function getAllSummary(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const source = e.parameter.source || 'new'; // 'new', 'history', 'all'
    const workersData = ss.getSheetByName(SHEET_NAMES.WORKERS).getDataRange().getValues();
    
    let records = [];
    let advances = [];
    
    // Načíst podle source
    if (source === 'new' || source === 'all') {
      const newRec = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
      const newAdv = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
      records = records.concat(newRec.slice(1)); // bez hlavičky
      advances = advances.concat(newAdv.slice(1));
    }
    if (source === 'history' || source === 'all') {
      const histRec = ss.getSheetByName('záznamy_historie').getDataRange().getValues();
      const histAdv = ss.getSheetByName('zálohy_historie').getDataRange().getValues();
      records = records.concat(histRec.slice(1));
      advances = advances.concat(histAdv.slice(1));
    }
    const summary = [];
   
    for (let w = 1; w < workersData.length; w++) {
      const workerId = workersData[w][0];
      const workerName = workersData[w][1];
      
      // Načíst datum přechodu a počáteční stav pro tohoto pracovníka
      const startData = getWorkerStartData(workersData, workerId);
      const datumOd = startData.datumOd;
      
      let totalEarnings = 0;
      let totalPaid = 0;
     
      for (let i = 0; i < records.length; i++) {
        if (String(records[i][1]) === String(workerId)) {
          if (datumOd) {
            const recordDate = new Date(records[i][4]);
            if (recordDate < datumOd) continue;
          }
          const rate = parseFloat(records[i][2]) || 0;
          const hours = parseFloat(records[i][7]) || 0;
          totalEarnings += (rate * hours);
        }
      }
     
      for (let i = 0; i < advances.length; i++) {
        if (String(advances[i][0]) === String(workerId)) {
          if (datumOd) {
            const advanceDate = new Date(advances[i][1]);
            if (advanceDate < datumOd) continue;
          }
          totalPaid += parseFloat(advances[i][4]) || 0;
        }
      }
      
      const balance = Math.round(startData.pocatek + totalEarnings - totalPaid);
     
      summary.push({
        id: workerId,
        name: workerName,
        totalEarnings: Math.round(totalEarnings),
        totalPaid: Math.round(totalPaid),
        pocatek: startData.pocatek,
        balance: balance
      });
    }
   
    return { code: '000', error: '', data: summary };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const source = e.parameter.source || 'new';
    let data = [];
    
    if (source === 'new' || source === 'all') {
      const records = ss.getSheetByName(SHEET_NAMES.RECORDS).getDataRange().getValues();
      for (let i = 1; i < records.length; i++) data.push(records[i]);
    }
    if (source === 'history' || source === 'all') {
      const records = ss.getSheetByName('záznamy_historie').getDataRange().getValues();
      for (let i = 1; i < records.length; i++) data.push(records[i]);
    }
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getAllAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const source = e.parameter.source || 'new';
    let data = [];
    
    if (source === 'new' || source === 'all') {
      const advances = ss.getSheetByName(SHEET_NAMES.ADVANCES).getDataRange().getValues();
      for (let i = 1; i < advances.length; i++) data.push(advances[i]);
    }
    if (source === 'history' || source === 'all') {
      const advances = ss.getSheetByName('zálohy_historie').getDataRange().getValues();
      for (let i = 1; i < advances.length; i++) data.push(advances[i]);
    }
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}


function addRecord(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheetRecords = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const idContract = e.parameter.id_contract;
    const idWorker = e.parameter.id_worker;
    const idJob = e.parameter.id_job;
    const idPlace = e.parameter.id_place || null;
    const timeFr = parseInt(e.parameter.time_fr);
    const timeTo = parseInt(e.parameter.time_to);
    const note = e.parameter.note || '';
    const recordDate = new Date(timeFr);
    const kmJednosmer = parseFloat(e.parameter.km_jednosmer) || 0;
    const kmCelkem = parseFloat(e.parameter.km_celkem) || 0;
    const kmRucne = e.parameter.km_rucne || 'N';
    const insertAfterDate = e.parameter.insert_after_date || null; // pro duplikaci
   
    // KONTROLA DUPLIKÁTŮ
    const existingRecords = sheetRecords.getDataRange().getValues();
    for (let i = 1; i < existingRecords.length; i++) {
      const existing = existingRecords[i];
      if (String(existing[1]) === String(idWorker) && 
          existing[4] === timeFr && 
          existing[5] === timeTo) {
        return { code: '101', error: 'Tato směna už je uložená (duplikát)', data: null };
      }
    }
   
    const nameContract = getNameById(ss, SHEET_NAMES.CONTRACTS, idContract);
    const nameJob = getNameById(ss, SHEET_NAMES.JOBS, idJob);
    const nameWorker = getNameById(ss, SHEET_NAMES.WORKERS, idWorker);
    const namePlace = idPlace ? getNameById(ss, SHEET_NAMES.PLACES, idPlace) : '';
    const rate = getWorkerRate(ss, idWorker, recordDate);
    
    const hours = (timeTo - timeFr) / 3600000;
    const dateTimeFr = Utilities.formatDate(new Date(timeFr), 'GMT+1', 'dd. MM. yyyy HH:mm');
    const dateTimeTo = Utilities.formatDate(new Date(timeTo), 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    // DUPLIKACE: vložit ZA poslední záznam daného dne + zapsat 'nový' do sloupce P
    if (insertAfterDate) {
      const newRowDup = [
        nameContract, idWorker, rate, nameJob,
        timeFr, timeTo, nameWorker, hours, note,
        dateTimeFr, dateTimeTo, kmJednosmer, kmCelkem, kmRucne,
        namePlace,
        'nový'   // sloupec P - zobrazí ikonku ➕ v apce
      ];

      const dateParts = insertAfterDate.split('. ');
      const targetDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
      const nextDay = new Date(targetDate);
      nextDay.setDate(nextDay.getDate() + 1);
      
      const allRecords = sheetRecords.getDataRange().getValues();
      let lastDayRow = -1;
      for (let i = 1; i < allRecords.length; i++) {
        const d = new Date(allRecords[i][4]);
        if (d >= targetDate && d < nextDay) {
          lastDayRow = i + 1;
        }
      }
      
      if (lastDayRow > 0) {
        sheetRecords.insertRowAfter(lastDayRow);
        sheetRecords.getRange(lastDayRow + 1, 1, 1, 16).setValues([newRowDup]);
      } else {
        sheetRecords.appendRow(newRowDup);
      }
    } else {
      // Normální přidání na konec - sloupec P prázdný
      sheetRecords.appendRow([
        nameContract, idWorker, rate, nameJob,
        timeFr, timeTo, nameWorker, hours, note,
        dateTimeFr, dateTimeTo, kmJednosmer, kmCelkem, kmRucne,
        namePlace, ''
      ]);
    }
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

// ============================================================
// UPRAVENÁ FUNKCE updateRecord
// Změna: po přepsání řádku vybarvíme buňky červeně
// aby bylo v sheetu vidět že byl záznam opraven
// Také přidáno místo (idPlace / namePlace)
// ============================================================
function updateRecord(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const rowIndex = parseInt(e.parameter.row_index);
    const idContract = e.parameter.id_contract;
    const idWorker = e.parameter.id_worker;
    const idJob = e.parameter.id_job;
    const idPlace = e.parameter.id_place || null;
    const timeFr = parseInt(e.parameter.time_fr);
    const timeTo = parseInt(e.parameter.time_to);
    const note = e.parameter.note || '';
    const kmJednosmer = parseFloat(e.parameter.km_jednosmer) || 0;
    const kmCelkem = parseFloat(e.parameter.km_celkem) || 0;
    const kmRucne = e.parameter.km_rucne || 'N';
   
    const nameContract = getNameById(ss, SHEET_NAMES.CONTRACTS, idContract);
    const nameJob = getNameById(ss, SHEET_NAMES.JOBS, idJob);
    const nameWorker = getNameById(ss, SHEET_NAMES.WORKERS, idWorker);
    const namePlace = idPlace ? getNameById(ss, SHEET_NAMES.PLACES, idPlace) : '';
    const recordDate = new Date(timeFr);
    const rate = getWorkerRate(ss, idWorker, recordDate);
    
    const hours = (timeTo - timeFr) / 3600000;
    const dateTimeFr = Utilities.formatDate(new Date(timeFr), 'GMT+1', 'dd. MM. yyyy HH:mm');
    const dateTimeTo = Utilities.formatDate(new Date(timeTo), 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    // rowIndex = i z getDayRecords (i=1 je první datový řádek = řádek 2 v sheetu)
    // Řádek v sheetu = rowIndex + 1
    if (isNaN(rowIndex) || rowIndex < 1) {
      return { code: '999', error: 'Neplatný index řádku: ' + rowIndex, data: null };
    }
    const row = rowIndex + 1;
    
    // Přepsat všechna data na původním řádku
    sheet.getRange(row, 1).setValue(nameContract);
    sheet.getRange(row, 2).setValue(idWorker);
    sheet.getRange(row, 3).setValue(rate);
    sheet.getRange(row, 4).setValue(nameJob);
    sheet.getRange(row, 5).setValue(timeFr);
    sheet.getRange(row, 6).setValue(timeTo);
    sheet.getRange(row, 7).setValue(nameWorker);
    sheet.getRange(row, 8).setValue(hours);
    sheet.getRange(row, 9).setValue(note);
    sheet.getRange(row, 10).setValue(dateTimeFr);
    sheet.getRange(row, 11).setValue(dateTimeTo);
    sheet.getRange(row, 12).setValue(kmJednosmer);
    sheet.getRange(row, 13).setValue(kmCelkem);
    sheet.getRange(row, 14).setValue(kmRucne);
    sheet.getRange(row, 15).setValue(namePlace);
    
    // Zapsat 'opraveno' do sloupce P (sloupec 16) - zobrazí se ikonka ✏️ v apce
    sheet.getRange(row, 16).setValue('opraveno');
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function deleteRecord(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const rowIndex = parseInt(e.parameter.row_index);
    sheet.deleteRow(rowIndex + 2);
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function setPaymentRequestLunch(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const time = parseInt(e.parameter.time);
    const lunchDate = new Date(time);
    
    const price = getLunchPrice(ss, lunchDate);
    const dateTime = Utilities.formatDate(lunchDate, 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    ss.getSheetByName(SHEET_NAMES.ADVANCES).appendRow([
      e.parameter.id_worker,
      time,
      e.parameter.name_worker,
      dateTime,
      price,
      'oběd'
    ]);
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function setPaymentRequest(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const time = parseInt(e.parameter.time);
    const dateTime = Utilities.formatDate(new Date(time), 'GMT+1', 'dd. MM. yyyy HH:mm');
   
    ss.getSheetByName(SHEET_NAMES.ADVANCES).appendRow([
      e.parameter.id_worker,
      time,
      e.parameter.name_worker,
      dateTime,
      parseFloat(e.parameter.payment),
      e.parameter.payment_reason
    ]);
   
    return { code: '000', error: '', data: null };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getNameById(ss, sheetName, id) {
  const data = ss.getSheetByName(sheetName).getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(id)) {
      return data[i][1];
    }
  }
  return id;
}

function getWorkerRate(ss, idWorker, recordDate) {
  const ratesData = ss.getSheetByName(SHEET_NAMES.RATES).getDataRange().getValues();
  for (let i = 1; i < ratesData.length; i++) {
    if (String(ratesData[i][0]) === String(idWorker)) {
      const dFrom = new Date(ratesData[i][3]);
      const dTo = new Date(ratesData[i][4]);
      if (recordDate >= dFrom && recordDate <= dTo) {
        return ratesData[i][2];
      }
    }
  }
  return 0;
}

function getLunchPrice(ss, lunchDate) {
  const pricesData = ss.getSheetByName(SHEET_NAMES.LUNCH_PRICES).getDataRange().getValues();
  for (let i = 1; i < pricesData.length; i++) {
    const dFrom = new Date(pricesData[i][1]);
    const dTo = new Date(pricesData[i][2]);
    if (lunchDate >= dFrom && lunchDate <= dTo) {
      return pricesData[i][0];
    }
  }
  return 0;
}

function getContractKm(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const contractsSheet = ss.getSheetByName(SHEET_NAMES.CONTRACTS);
    const data = contractsSheet.getDataRange().getValues();
    const contractId = e.parameter.id_contract;
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) === String(contractId)) {
        const km = data[i][3] || 0;
        return { code: '000', error: '', data: { km: km } };
      }
    }
    
    return { code: '000', error: '', data: { km: 0 } };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function checkTodayTrip(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const recordsSheet = ss.getSheetByName(SHEET_NAMES.RECORDS);
    const data = recordsSheet.getDataRange().getValues();
    const contractName = e.parameter.id_contract;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayMs = today.getTime();
    
    for (let i = 1; i < data.length; i++) {
      const recordDate = new Date(data[i][4]);
      recordDate.setHours(0, 0, 0, 0);
      const recordDateMs = recordDate.getTime();
      const recordContractName = String(data[i][0]);
      const recordKm = data[i][12] || 0;
      
      if (recordDateMs === todayMs && recordContractName === contractName && recordKm > 0) {
        return { 
          code: '000', 
          error: '', 
          data: { 
            exists: true, 
            km: recordKm,
            worker: data[i][6]
          }
        };
      }
    }
    
    return { code: '000', error: '', data: { exists: false } };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}


// Vrátí datum přechodu a počátek pro všechny pracovníky
// Používá se v admin přehledu - odděleně od getData workers
function getAllWorkersStartData(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAMES.WORKERS);
    const lastRow = sheet.getLastRow();
    if (lastRow < 2) return { code: '000', error: '', data: [] };
    const data = sheet.getRange(2, 1, lastRow - 1, 6).getValues();
    const result = [];
    for (let i = 0; i < data.length; i++) {
      let datumOd = null;
      const datumRaw = data[i][4];
      if (datumRaw) {
        if (datumRaw instanceof Date) {
          datumOd = datumRaw.getTime();
        } else if (typeof datumRaw === 'number') {
          datumOd = new Date((datumRaw - 25569) * 86400000).getTime();
        }
      }
      result.push({
        id: data[i][0],
        name: data[i][1],
        datumOd: datumOd,
        pocatek: parseFloat(data[i][5]) || 0
      });
    }
    return { code: '000', error: '', data: result };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

// ============================================================
// HISTORICKÉ FUNKCE - načítají se jen na vyžádání
// Čtou z listů záznamy_historie a zálohy_historie
// ============================================================

// Záznamy z historie - pro konkrétního pracovníka nebo všechny
function getHistoryRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('záznamy_historie');
    if (!sheet) return { code: '000', error: '', data: [] };
    
    const records = sheet.getDataRange().getValues();
    const idWorker = e.parameter.id_worker || null;
    const data = [];
    
    for (let i = 1; i < records.length; i++) {
      if (!idWorker || String(records[i][1]) === String(idWorker)) {
        data.push(records[i]);
      }
    }
    
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

// Zálohy z historie - pro konkrétního pracovníka nebo všechny
function getHistoryAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('zálohy_historie');
    if (!sheet) return { code: '000', error: '', data: [] };
    
    const advances = sheet.getDataRange().getValues();
    const idWorker = e.parameter.id_worker || null;
    const data = [];
    
    for (let i = 1; i < advances.length; i++) {
      if (!idWorker || String(advances[i][1]) === String(idWorker)) {
        data.push(advances[i]);
      }
    }
    
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

// Souhrn z POUZE historických dat (záznamy_historie + zálohy_historie)
// Používá se v admin panelu pro přehled přes roky
function getHistorySummary(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const workersData = ss.getSheetByName(SHEET_NAMES.WORKERS).getDataRange().getValues();
    
    const histRecordsSheet = ss.getSheetByName('záznamy_historie');
    const histAdvancesSheet = ss.getSheetByName('zálohy_historie');
    const histRecords = histRecordsSheet ? histRecordsSheet.getDataRange().getValues() : [];
    const histAdvances = histAdvancesSheet ? histAdvancesSheet.getDataRange().getValues() : [];
    
    const summary = [];
    
    for (let w = 1; w < workersData.length; w++) {
      const workerId = workersData[w][0];
      const workerName = workersData[w][1];
      let totalEarnings = 0;
      let totalPaid = 0;
      
      for (let i = 1; i < histRecords.length; i++) {
        if (String(histRecords[i][1]) === String(workerId)) {
          const rate = parseFloat(histRecords[i][2]) || 0;
          const hours = parseFloat(histRecords[i][7]) || 0;
          totalEarnings += (rate * hours);
        }
      }
      
      for (let i = 1; i < histAdvances.length; i++) {
        if (String(histAdvances[i][1]) === String(workerId)) {
          totalPaid += parseFloat(histAdvances[i][4]) || 0;
        }
      }
      
      if (totalEarnings > 0 || totalPaid > 0) {
        summary.push({
          id: workerId,
          name: workerName,
          totalEarnings: Math.round(totalEarnings),
          totalPaid: Math.round(totalPaid),
          balance: Math.round(totalEarnings - totalPaid)
        });
      }
    }
    
    return { code: '000', error: '', data: summary };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }


// ============================================================
// HISTORICKÉ FUNKCE - PŘESNÁ KOPIE getAllSummary/Records/Advances
// jen s listem záznamy_historie místo záznamy
// ============================================================

// NOVÉ AKCE PRO HISTORII - PŘESNÁ KOPIE getAllSummary/Records/Advances
// jen s jiným listem

function getHistorySummary(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const workersData = ss.getSheetByName(SHEET_NAMES.WORKERS).getDataRange().getValues();
    const records = ss.getSheetByName('záznamy_historie').getDataRange().getValues();
    const advances = ss.getSheetByName('zálohy_historie').getDataRange().getValues();
    const summary = [];
   
    for (let w = 1; w < workersData.length; w++) {
      const workerId = workersData[w][0];
      const workerName = workersData[w][1];
      
      // Načíst datum přechodu a počáteční stav pro tohoto pracovníka
      const startData = getWorkerStartData(workersData, workerId);
      const datumOd = startData.datumOd;
      
      let totalEarnings = 0;
      let totalPaid = 0;
     
      for (let i = 0; i < records.length; i++) {
        if (String(records[i][1]) === String(workerId)) {
          if (datumOd) {
            const recordDate = new Date(records[i][4]);
            if (recordDate < datumOd) continue;
          }
          const rate = parseFloat(records[i][2]) || 0;
          const hours = parseFloat(records[i][7]) || 0;
          totalEarnings += (rate * hours);
        }
      }
     
      for (let i = 0; i < advances.length; i++) {
        if (String(advances[i][0]) === String(workerId)) {
          if (datumOd) {
            const advanceDate = new Date(advances[i][1]);
            if (advanceDate < datumOd) continue;
          }
          totalPaid += parseFloat(advances[i][4]) || 0;
        }
      }
      
      const balance = Math.round(startData.pocatek + totalEarnings - totalPaid);
     
      summary.push({
        id: workerId,
        name: workerName,
        totalEarnings: Math.round(totalEarnings),
        totalPaid: Math.round(totalPaid),
        pocatek: startData.pocatek,
        balance: balance
      });
    }
   
    return { code: '000', error: '', data: summary };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getHistoryRecords(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const records = ss.getSheetByName('záznamy_historie').getDataRange().getValues();
    const data = [];
    
    for (let i = 1; i < records.length; i++) {
      data.push(records[i]);
    }
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

function getHistoryAdvances(e) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const advances = ss.getSheetByName('zálohy_historie').getDataRange().getValues();
    const data = [];
    
    for (let i = 1; i < advances.length; i++) {
      data.push(advances[i]);
    }
   
    return { code: '000', error: '', data: data.reverse() };
  } catch (error) {
    return { code: '999', error: error.toString(), data: null };
  }
}

}
