<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1976D2">
  <title>Evidence práce</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  
  <!-- Quasar CSS -->
  <link href="https://fonts.googleapis.com/css?family=Material+Icons" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quasar@2.11.3/dist/quasar.prod.css" rel="stylesheet">
  
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .login-card { background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 400px; width: 90%; }
    .app-header { background: #1976D2; color: white; padding: 1rem; text-align: center; font-size: 1.2rem; font-weight: bold; }
    .tab-content { padding: 1rem; }
    .record-card { border: 2px solid #ddd; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.5rem; }
    .time-btn { font-size: 1.2rem; padding: 1rem; }
    .summary-box { background: #f5f5f5; padding: 1rem; border-radius: 0.5rem; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quasar@2.11.3/dist/quasar.umd.prod.js"></script>
  
  <script>
    // ============ KONFIGURACE ============
    const API_URL = 'https://script.google.com/macros/s/AKfycbwxDHb9Qo0QpO7aTHX7xfvNx1ba-Cf9YIypAEX12otdOD9xPwkNschVLL-qviq-oJxdgQ/exec';
    
    // ============ API HELPER ============
    async function apiCall(action, params = {}) {
      const url = new URL(API_URL);
      url.searchParams.append('action', action);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.code === "000") return { success: true, data: data.data };
        else return { success: false, error: data.error || 'Chyba API' };
      } catch (error) {
        return { success: false, error: 'Chyba připojení' };
      }
    }

    // ============ VUE APP ============
    const app = Vue.createApp({
      data() {
        return {
          isLoggedIn: false,
          loginCode: '',
          currentUser: null,
          isAdmin: false,
          
          // Data z API
          contracts: [],
          jobs: [],
          workers: [],
          
          // Navigace
          currentView: 'home',
          currentTab: 'shift',
          
          // Formuláře
          shiftForm: {
            contractId: null,
            jobId: null,
            timeStart: null,
            timeEnd: null,
            note: ''
          },
          
          lunchForm: {
            date: this.getTodayDate()
          },
          
          advanceForm: {
            amount: null,
            reason: '',
            date: this.getTodayDate()
          },
          
          // Přehledy
          summaryDateFrom: this.getMonthStart(),
          summaryDateTo: this.getTodayDate(),
          summaryData: null,
          records: [],
          
          // UI stavy
          loading: false,
          message: ''
        }
      },
      
      methods: {
        // ========== PŘIHLÁŠENÍ ==========
        async login() {
          if (!this.loginCode) {
            this.showMessage('Zadejte kód pracovníka');
            return;
          }
          
          this.loading = true;
          const result = await apiCall('get', { type: 'workers' });
          
          if (result.success) {
            const worker = result.data.find(w => w[0].toString() === this.loginCode);
            if (worker) {
              this.currentUser = {
                id: worker[0],
                name: worker[1],
                active: worker[2] === 'Y',
                admin: worker[3] === 'Y'
              };
              this.isAdmin = this.currentUser.admin;
              this.isLoggedIn = true;
              localStorage.setItem('workerId', worker[0]);
              await this.loadData();
            } else {
              this.showMessage('Neplatný kód pracovníka');
            }
          } else {
            this.showMessage('Chyba při přihlášení: ' + result.error);
          }
          
          this.loading = false;
        },
        
        logout() {
          this.isLoggedIn = false;
          this.currentUser = null;
          this.loginCode = '';
          localStorage.removeItem('workerId');
        },
        
        // ========== NAČÍTÁNÍ DAT ==========
        async loadData() {
          this.loading = true;
          
          const [contractsRes, jobsRes] = await Promise.all([
            apiCall('get', { type: 'contracts' }),
            apiCall('get', { type: 'jobs' })
          ]);
          
          if (contractsRes.success) this.contracts = contractsRes.data;
          if (jobsRes.success) this.jobs = jobsRes.data;
          
          this.loading = false;
        },
        
        // ========== ZÁPIS SMĚNY ==========
        async saveShift() {
          if (!this.shiftForm.contractId || !this.shiftForm.jobId || !this.shiftForm.timeStart || !this.shiftForm.timeEnd) {
            this.showMessage('Vyplňte všechna pole');
            return;
          }
          
          this.loading = true;
          
          const result = await apiCall('saverecord', {
            id_contract: this.shiftForm.contractId,
            id_worker: this.currentUser.id,
            id_job: this.shiftForm.jobId,
            time_fr: this.shiftForm.timeStart,
            time_to: this.shiftForm.timeEnd
          });
          
          if (result.success) {
            this.showMessage('Směna uložena');
            this.resetShiftForm();
          } else {
            this.showMessage('Chyba: ' + result.error);
          }
          
          this.loading = false;
        },
        
        // ========== PŘÍCHOD / ODCHOD ==========
        setArrival() {
          this.shiftForm.timeStart = Date.now();
          this.showMessage('Příchod zaznamenán: ' + this.formatTime(this.shiftForm.timeStart));
        },
        
        setDeparture() {
          if (!this.shiftForm.timeStart) {
            this.showMessage('Nejdříve zaznamenejte příchod');
            return;
          }
          this.shiftForm.timeEnd = Date.now();
          this.showMessage('Odchod zaznamenán: ' + this.formatTime(this.shiftForm.timeEnd));
        },
        
        // ========== ZÁPIS OBĚDA ==========
        async saveLunch() {
          if (!this.lunchForm.date) {
            this.showMessage('Vyberte datum');
            return;
          }
          
          this.loading = true;
          
          const result = await apiCall('savelunch', {
            id_worker: this.currentUser.id,
            time: Date.now(),
            name_worker: this.currentUser.name,
            date: this.lunchForm.date
          });
          
          if (result.success) {
            this.showMessage('Oběd uložen');
            this.lunchForm.date = this.getTodayDate();
          } else {
            this.showMessage('Chyba: ' + result.error);
          }
          
          this.loading = false;
        },
        
        // ========== ZÁPIS ZÁLOHY ==========
        async saveAdvance() {
          if (!this.advanceForm.amount || !this.advanceForm.reason) {
            this.showMessage('Vyplňte částku a důvod');
            return;
          }
          
          this.loading = true;
          
          const result = await apiCall('saveadvance', {
            id_worker: this.currentUser.id,
            time: Date.now(),
            name_worker: this.currentUser.name,
            date: this.advanceForm.date,
            payment: this.advanceForm.amount,
            payment_reason: this.advanceForm.reason
          });
          
          if (result.success) {
            this.showMessage('Záloha uložena');
            this.advanceForm.amount = null;
            this.advanceForm.reason = '';
          } else {
            this.showMessage('Chyba: ' + result.error);
          }
          
          this.loading = false;
        },
        
        // ========== PŘEHLEDY ==========
        async loadSummary() {
          this.loading = true;
          
          const result = await apiCall('getsummary', {
            id: this.currentUser.id,
            date_fr: this.summaryDateFrom,
            date_to: this.summaryDateTo
          });
          
          if (result.success && result.data.length === 3) {
            this.summaryData = {
              hours: result.data[0],
              earned: result.data[1],
              paid: result.data[2],
              balance: result.data[1] - result.data[2]
            };
          } else {
            this.showMessage('Chyba načítání přehledu');
          }
          
          this.loading = false;
        },
        
        async loadRecords() {
          this.loading = true;
          
          const result = await apiCall('getrecords', {
            id: this.currentUser.id,
            date_fr: this.summaryDateFrom,
            date_to: this.summaryDateTo,
            names: true
          });
          
          if (result.success) {
            this.records = result.data;
          }
          
          this.loading = false;
        },
        
        // ========== HELPER FUNKCE ==========
        resetShiftForm() {
          this.shiftForm = {
            contractId: null,
            jobId: null,
            timeStart: null,
            timeEnd: null,
            note: ''
          };
        },
        
        showMessage(msg) {
          this.message = msg;
          setTimeout(() => this.message = '', 3000);
        },
        
        formatTime(timestamp) {
          return new Date(timestamp).toLocaleString('cs-CZ', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        },
        
        formatDateTime(timestamp) {
          return new Date(timestamp).toLocaleString('cs-CZ', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        },
        
        getTodayDate() {
          const today = new Date();
          const day = String(today.getDate()).padStart(2, '0');
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const year = today.getFullYear();
          return `${day}. ${month}. ${year}`;
        },
        
        getMonthStart() {
          const today = new Date();
          const day = '01';
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const year = today.getFullYear();
          return `${day}. ${month}. ${year}`;
        }
      },
      
      computed: {
        contractOptions() {
          return this.contracts.map(c => ({ label: `${c[0]} - ${c[1]}`, value: c[0] }));
        },
        
        jobOptions() {
          return this.jobs.map(j => ({ label: j[1], value: j[0] }));
        }
      },
      
      mounted() {
        // Auto-login pokud je uložený ID
        const savedId = localStorage.getItem('workerId');
        if (savedId) {
          this.loginCode = savedId;
          this.login();
        }
      },
      
      template: `
        <div v-if="!isLoggedIn" class="login-container">
          <div class="login-card">
            <h1 style="text-align: center; color: #1976D2;">Evidence práce</h1>
            <q-input
              v-model="loginCode"
              label="Kód pracovníka"
              type="number"
              outlined
              @keyup.enter="login"
              class="q-mb-md"
            />
            <q-btn
              @click="login"
              label="Přihlásit"
              color="primary"
              :loading="loading"
              class="full-width"
              size="lg"
            />
          </div>
        </div>

        <q-layout view="hHh lpR fFf" v-else>
          <q-header class="app-header">
            <div>Evidence práce - {{ currentUser.name }}</div>
          </q-header>

          <q-page-container>
            <!-- HOME -->
            <div v-if="currentView === 'home'" class="tab-content">
              <q-tabs v-model="currentTab" dense align="justify">
                <q-tab name="shift" label="Směna" />
                <q-tab name="lunch" label="Oběd" />
                <q-tab name="advance" label="Záloha" />
              </q-tabs>

              <!-- SMĚNA -->
              <div v-if="currentTab === 'shift'" class="q-pt-md">
                <q-btn @click="setArrival" color="green" icon="login" label="PŘÍCHOD" class="full-width q-mb-md time-btn" :disabled="shiftForm.timeStart" />
                <div v-if="shiftForm.timeStart" class="q-mb-md text-center">
                  Příchod: {{ formatTime(shiftForm.timeStart) }}
                </div>
                
                <q-btn @click="setDeparture" color="orange" icon="logout" label="ODCHOD" class="full-width q-mb-md time-btn" :disabled="!shiftForm.timeStart || shiftForm.timeEnd" />
                <div v-if="shiftForm.timeEnd" class="q-mb-md text-center">
                  Odchod: {{ formatTime(shiftForm.timeEnd) }}
                </div>

                <q-select v-model="shiftForm.contractId" :options="contractOptions" label="Zakázka" emit-value map-options outlined class="q-mb-md" />
                <q-select v-model="shiftForm.jobId" :options="jobOptions" label="Práce" emit-value map-options outlined class="q-mb-md" />
                <q-input v-model="shiftForm.note" label="Poznámka" outlined class="q-mb-md" />
                
                <q-btn @click="saveShift" label="Uložit směnu" color="primary" :loading="loading" class="full-width" size="lg" :disabled="!shiftForm.timeStart || !shiftForm.timeEnd" />
              </div>

              <!-- OBĚD -->
              <div v-if="currentTab === 'lunch'" class="q-pt-md">
                <q-input v-model="lunchForm.date" label="Datum" outlined readonly class="q-mb-md" />
                <q-btn @click="saveLunch" label="Uložit oběd" color="primary" :loading="loading" class="full-width" size="lg" />
              </div>

              <!-- ZÁLOHA -->
              <div v-if="currentTab === 'advance'" class="q-pt-md">
                <q-input v-model.number="advanceForm.amount" label="Částka (Kč)" type="number" outlined class="q-mb-md" />
                <q-input v-model="advanceForm.reason" label="Důvod" outlined class="q-mb-md" />
                <q-input v-model="advanceForm.date" label="Datum" outlined readonly class="q-mb-md" />
                <q-btn @click="saveAdvance" label="Uložit zálohu" color="primary" :loading="loading" class="full-width" size="lg" />
              </div>
            </div>

            <!-- PŘEHLEDY -->
            <div v-if="currentView === 'summary'" class="tab-content">
              <h3>Finanční přehled</h3>
              <q-input v-model="summaryDateFrom" label="Od" outlined class="q-mb-md" />
              <q-input v-model="summaryDateTo" label="Do" outlined class="q-mb-md" />
              <q-btn @click="loadSummary" label="Načíst přehled" color="primary" class="full-width q-mb-md" />
              
              <div v-if="summaryData" class="summary-box">
                <div><strong>Odpracováno:</strong> {{ summaryData.hours }} hod</div>
                <div><strong>Vyděleno:</strong> {{ summaryData.earned }} Kč</div>
                <div><strong>Vyplaceno:</strong> {{ summaryData.paid }} Kč</div>
                <div><strong>Zůstatek:</strong> {{ summaryData.balance }} Kč</div>
              </div>

              <q-btn @click="loadRecords" label="Zobrazit záznamy" color="secondary" class="full-width q-mt-md" />
              
              <div v-if="records.length" class="q-mt-md">
                <div v-for="(record, i) in records" :key="i" class="record-card">
                  <div><strong>{{ record[0] }}</strong> - {{ record[3] }}</div>
                  <div>{{ formatDateTime(record[4]) }} - {{ formatDateTime(record[5]) }}</div>
                  <div>Sazba: {{ record[2] }} Kč/hod</div>
                </div>
              </div>
            </div>

            <!-- MESSAGE -->
            <q-banner v-if="message" class="bg-primary text-white">
              {{ message }}
            </q-banner>
          </q-page-container>

          <!-- BOTTOM NAVIGATION -->
          <q-footer class="bg-white text-primary">
            <q-tabs v-model="currentView" dense align="justify">
              <q-tab name="home" icon="home" label="Domů" />
              <q-tab name="summary" icon="assessment" label="Přehledy" />
              <q-tab name="settings" icon="settings" label="Nastavení" />
            </q-tabs>
          </q-footer>
        </q-layout>
      `
    });

    app.use(Quasar);
    app.mount('#app');
  </script>
</body>
</html>
